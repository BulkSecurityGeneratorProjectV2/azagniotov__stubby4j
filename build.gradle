// vim: ft=groovy
import org.kt3k.gradle.plugin.coveralls.domain.CoberturaSourceReportFactory
ext.coberturaSourceReportFactory = new CoberturaSourceReportFactory()

defaultTasks 'clean', 'build'
description = 'Gradle configuration for stubby4j'

buildscript {
   repositories {
      mavenCentral()
      jcenter()
   }

   dependencies {
      classpath 'com.bmuschko:gradle-nexus-plugin:2.3'
      classpath 'org.kt3k.gradle.plugin:coveralls-gradle-plugin:2.3.1'
   }
}

def totalTestCounter = 0
allprojects {
   apply plugin: 'java'
   apply plugin: 'idea'
   apply plugin: 'eclipse'
   project.buildDir = 'target'

   if (project.name != 'main') {
      tasks.withType(Test) {
         Task testTask ->
            def totalSuiteCount = 0
            def successSuiteCount = 0
            testLogging {
               events /*"passed", */"skipped", "failed"
               exceptionFormat "full"
               showExceptions true
               showCauses true
               showStackTraces true
            }
            afterSuite { testDescriptor, testResult ->
               if (testDescriptor.getName().contains("$stubbyProjectGroup")) {
                  totalSuiteCount += testResult.getTestCount()
                  totalTestCounter += testResult.getTestCount()
                  successSuiteCount += testResult.getSuccessfulTestCount()
               }
            }
            doLast {
               println ""
               println "::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::"
               println ":::::                         Ran " + project.name.toUpperCase() + " module tests"
               println "::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::"
               println ":::::                             Passed (" + successSuiteCount + "/" + totalSuiteCount  + ") tests"
               println ":::::               Total tests executed in $stubbyProjectName project so far " + totalTestCounter
               println "::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::"
               println ""
            } 
      }
   }
}

apply from: "$rootDir/conf/gradle/ides.gradle"

subprojects {
   subproject ->
      sourceCompatibility = 1.7
      tasks.withType(JavaCompile) {
         doFirst {
            assert sourceCompatibility == "1.7": "The sourceCompatibility of $name was changed!"
         }
         options.encoding = 'UTF-8'
      }
      targetCompatibility = 1.7

      repositories {
         mavenCentral()
         jcenter()
         mavenLocal()
      }
      
      apply from: "$rootDir/conf/gradle/dependency.gradle"
}
